/*!
 * @ahone/svg2canvas v0.0.2
 * (c) 2021-2022 FatDragon-Chan
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).svg2canvas={})}(this,(function(t){"use strict";class e{constructor(t){this.id=C(),this.nanoid=t,this.listeners={}}draw(t){throw new Error("Method not implemented.")}clone(t){throw new Error("Method not implemented.")}on(t,e){this.listeners[t]?this.listeners[t].push(e):this.listeners[t]=[e]}getListeners(){return this.listeners}getId(){return this.id}}class s extends e{constructor(t){super(t.nanoid),this.props=t,this.props.fillColor=this.props.fillColor||"#fff",this.props.strokeColor=this.props.strokeColor||"#000",this.props.strokeWidth=this.props.strokeWidth||1}draw(t){const{fillColor:e,translate:s,points:r}=this.props,i=r.split(" ").filter((t=>""!==t)),n=[],o=[];i.forEach(((t,e)=>{e%2==0?n.push(t):o.push(t)})),t.save(),t.beginPath(),t.translate(s[0],s[1]),n.forEach(((e,s)=>{s<=0?t.moveTo(e,o[s]):t.lineTo(e,o[s])})),t.fillStyle=e,t.fill(),t.restore()}clone(){const[t,e,r,i]=x(this.id);return new s(Object.assign(Object.assign({},this.props),{fillColor:`rgba(${t}, ${e}, ${r}, ${i})`}))}}var r=function(t){var e=[];return t.replace(n,(function(t,s,r){var n=s.toLowerCase();for(r=function(t){var e=t.match(o);return e?e.map(Number):[]}(r),"m"==n&&r.length>2&&(e.push([s].concat(r.splice(0,2))),n="l",s="m"==s?"l":"L");;){if(r.length==i[n])return r.unshift(s),e.push(r);if(r.length<i[n])throw new Error("malformed path data");e.push([s].concat(r.splice(0,i[n])))}})),e},i={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},n=/([astvzqmhlc])([^astvzqmhlc]*)/gi;var o=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/gi;var a=function(t){var e=0,s=0,r=0,i=0;return t.map((function(t){var n=(t=t.slice())[0],o=n.toUpperCase();if(n!=o)switch(t[0]=o,n){case"a":t[6]+=r,t[7]+=i;break;case"v":t[1]+=i;break;case"h":t[1]+=r;break;default:for(var a=1;a<t.length;)t[a++]+=r,t[a++]+=i}switch(o){case"Z":r=e,i=s;break;case"H":r=t[1];break;case"V":i=t[1];break;case"M":r=e=t[1],i=s=t[2];break;default:r=t[t.length-2],i=t[t.length-1]}return t}))};var h,l=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var s=[],r=!0,i=!1,n=void 0;try{for(var o,a=t[Symbol.iterator]();!(r=(o=a.next()).done)&&(s.push(o.value),!e||s.length!==e);r=!0);}catch(t){i=!0,n=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw n}}return s}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},c=2*Math.PI,d=function(t,e,s,r,i,n,o){var a=t.x,h=t.y;return{x:r*(a*=e)-i*(h*=s)+n,y:i*a+r*h+o}},p=function(t,e){var s=1.5707963267948966===e?.551915024494:-1.5707963267948966===e?-.551915024494:4/3*Math.tan(e/4),r=Math.cos(t),i=Math.sin(t),n=Math.cos(t+e),o=Math.sin(t+e);return[{x:r-i*s,y:i+r*s},{x:n+o*s,y:o-n*s},{x:n,y:o}]},u=function(t,e,s,r){var i=t*s+e*r;return i>1&&(i=1),i<-1&&(i=-1),(t*r-e*s<0?-1:1)*Math.acos(i)},f=function(t){var e=t.px,s=t.py,r=t.cx,i=t.cy,n=t.rx,o=t.ry,a=t.xAxisRotation,h=void 0===a?0:a,f=t.largeArcFlag,v=void 0===f?0:f,g=t.sweepFlag,y=void 0===g?0:g,m=[];if(0===n||0===o)return[];var w=Math.sin(h*c/360),x=Math.cos(h*c/360),M=x*(e-r)/2+w*(s-i)/2,b=-w*(e-r)/2+x*(s-i)/2;if(0===M&&0===b)return[];n=Math.abs(n),o=Math.abs(o);var C=Math.pow(M,2)/Math.pow(n,2)+Math.pow(b,2)/Math.pow(o,2);C>1&&(n*=Math.sqrt(C),o*=Math.sqrt(C));var k=function(t,e,s,r,i,n,o,a,h,l,d,p){var f=Math.pow(i,2),v=Math.pow(n,2),g=Math.pow(d,2),y=Math.pow(p,2),m=f*v-f*y-v*g;m<0&&(m=0),m/=f*y+v*g;var w=(m=Math.sqrt(m)*(o===a?-1:1))*i/n*p,x=m*-n/i*d,M=l*w-h*x+(t+s)/2,b=h*w+l*x+(e+r)/2,C=(d-w)/i,k=(p-x)/n,E=(-d-w)/i,S=(-p-x)/n,A=u(1,0,C,k),P=u(C,k,E,S);return 0===a&&P>0&&(P-=c),1===a&&P<0&&(P+=c),[M,b,A,P]}(e,s,r,i,n,o,v,y,w,x,M,b),E=l(k,4),S=E[0],A=E[1],P=E[2],j=E[3],I=Math.abs(j)/(c/4);Math.abs(1-I)<1e-7&&(I=1);var O=Math.max(Math.ceil(I),1);j/=O;for(var R=0;R<O;R++)m.push(p(P,j)),P+=j;return m.map((function(t){var e=d(t[0],n,o,x,w,S,A),s=e.x,r=e.y,i=d(t[1],n,o,x,w,S,A),a=i.x,h=i.y,l=d(t[2],n,o,x,w,S,A);return{x1:s,y1:r,x2:a,y2:h,x:l.x,y:l.y}}))};function v(t,e,s,r){return["C",t,e,s,r,s,r]}function g(t,e,s,r,i,n){return["C",t/3+2/3*s,e/3+2/3*r,i/3+2/3*s,n/3+2/3*r,i,n]}class y extends e{constructor(t){super(t.nanoid),this.props=t,this.props.fillColor=this.props.fillColor||"#fff"}draw(t){const{fillColor:e,d:s,translate:i=[0,0]}=this.props;if(!("string"==typeof(n=s)&&(n=n.trim(),/^[mzlhvcsqta]\s*[-+.0-9][^mlhvzcsqta]+/i.test(n)&&/[\dz]$/i.test(n)&&n.length>4)))throw new Error("Not an SVG path!");var n;const o=function(t){for(var e,s=[],r=0,i=0,n=0,o=0,a=null,h=null,l=0,c=0,d=0,p=t.length;d<p;d++){var u=t[d],y=u[0];switch(y){case"M":n=u[1],o=u[2];break;case"A":var m=f({px:l,py:c,cx:u[6],cy:u[7],rx:u[1],ry:u[2],xAxisRotation:u[3],largeArcFlag:u[4],sweepFlag:u[5]});if(!m.length)continue;for(var w,x=0;x<m.length;x++)u=["C",(w=m[x]).x1,w.y1,w.x2,w.y2,w.x,w.y],x<m.length-1&&s.push(u);break;case"S":var M=l,b=c;"C"!=e&&"S"!=e||(M+=M-r,b+=b-i),u=["C",M,b,u[1],u[2],u[3],u[4]];break;case"T":"Q"==e||"T"==e?(a=2*l-a,h=2*c-h):(a=l,h=c),u=g(l,c,a,h,u[1],u[2]);break;case"Q":a=u[1],h=u[2],u=g(l,c,u[1],u[2],u[3],u[4]);break;case"L":u=v(l,c,u[1],u[2]);break;case"H":u=v(l,c,u[1],c);break;case"V":u=v(l,c,l,u[1]);break;case"Z":u=v(l,c,n,o)}e=y,l=u[u.length-2],c=u[u.length-1],u.length>4?(r=u[u.length-4],i=u[u.length-3]):(r=l,i=c),s.push(u)}return s}(a(r(s)));t.save(),t.beginPath(),t.translate(i[0],i[1]),o.length&&(o.forEach((e=>{const[s,...r]=e;"M"===s?t.moveTo(...r):t.bezierCurveTo(...r)})),t.closePath(),t.fillStyle=e,t.fill(),t.restore())}clone(){const[t,e,s,r]=x(this.id);return new y(Object.assign(Object.assign({},this.props),{fillColor:`rgba(${t}, ${e}, ${s}, ${r})`}))}}class m extends e{constructor(t){super(t.nanoid),this.props=t,this.props.fillColor=this.props.fillColor||"#fff",this.props.strokeColor=this.props.strokeColor||"#000",this.props.strokeWidth=this.props.strokeWidth||1}draw(t){const{x:e,y:s,radius:r,fillColor:i,translate:n}=this.props;t.save(),t.beginPath(),t.scale(.5,.5),t.translate(n[0],n[1]),t.fillStyle=i,t.arc(e,s,r,0,2*Math.PI),t.fill(),t.restore()}clone(){const[t,e,s,r]=x(this.id);return new m(Object.assign(Object.assign({},this.props),{fillColor:`rgba(${t}, ${e}, ${s}, ${r})`}))}}t.EventNames=void 0,(h=t.EventNames||(t.EventNames={})).click="click",h.mousedown="mousedown",h.mousemove="mousemove",h.mouseup="mouseup",h.mouseenter="mouseenter",h.mouseleave="mouseleave";const w={};function x(t){return t.split("-")}function M(t){return t.join("-")}function b(){return Array(3).fill(0).map((()=>Math.ceil(255*Math.random()))).concat(255).join("-")}function C(){let t=b();for(;w[t];)t=b();return t}const k=t=>{const e=t=>{const{d:e="",translate:s,fill:r="#F4F5F6",dpr:i=1,nanoid:n=""}=t;return new y({fillColor:r,d:e,translate:s,dpr:i,nanoid:n})},r=t=>{const{fill:e,translate:r,points:i="",nanoid:n=""}=t;return new s({fillColor:e,points:i,translate:r,nanoid:n})};switch(t){case"path":return e;case"polygon":return r;default:return null}};var E;!function(t){t.Down="DOWN",t.Up="Up",t.Move="MOVE"}(E||(E={}));class S{constructor(){this.listenersMap={}}addAction(e,s){const{type:r,id:i}=e;r===E.Move&&this.fire(i,t.EventNames.mousemove,s),r!==E.Move||this.lastMoveId&&this.lastMoveId===i||(this.fire(i,t.EventNames.mouseenter,s),this.fire(this.lastMoveId,t.EventNames.mouseleave,s)),r===E.Down&&this.fire(i,t.EventNames.mousedown,s),r===E.Up&&this.fire(i,t.EventNames.mouseup,s),r===E.Up&&this.lastDownId===i&&this.fire(i,t.EventNames.click,s),r===E.Move?this.lastMoveId=e.id:r===E.Down&&(this.lastDownId=e.id)}addListeners(t,e){this.listenersMap[t]=e}fire(t,e,s){this.listenersMap[t]&&this.listenersMap[t][e]&&this.listenersMap[t][e].forEach((t=>t(s)))}}t.Circle=m,t.Path=y,t.Polygon=s,t.Stage=class{constructor({canvasRes:t,osCanvasRes:e,width:s,height:r,dpr:i=2},n){this.width=s,this.height=r,this.canvas=t,this.offCanvas=e,this.renderChildren=[],this.ctx=this.canvas.getContext("2d"),this.offCtx=this.offCanvas.getContext("2d"),this.dpr=i,this.canvas.width=s*this.dpr,this.canvas.height=r*this.dpr,this.ctx.scale(this.dpr,this.dpr),this.offCanvas.width=s*this.dpr,this.offCanvas.height=r*this.dpr,this.offCtx.scale(this.dpr,this.dpr),this.shapesSet=new Set,this.onChange=n,this.shapesActionsList=[],this.setProxy(),this.eventSimulator=new S}init(e){e.forEach((({children:e,nature:s,nanoid:r=""})=>{e&&e.forEach((e=>{const i=k(e.type);if(!i)throw new Error(e.type?`${e.type}该类型暂未支持。`:"请传入正确格式的svg解析配置");const n=i&&i(Object.assign(Object.assign({},e),{dpr:this.dpr,nanoid:r}));n&&(s&&"interaction"===s&&r&&n.on(t.EventNames.click,(()=>{const t=Reflect.get(this.shapesActionsProxy,r);Reflect.set(this.shapesActionsProxy,r,!t),this.render()})),this.add(n))}))}))}add(t){if(Object.keys(t.getListeners()).length>0){const e=t.getId();this.eventSimulator.addListeners(e,t.getListeners()),this.shapesSet.add(e)}this.renderChildren.push(t)}render(){this.ctx.clearRect(0,0,this.width,this.height),this.renderChildren&&this.renderChildren.forEach((t=>{Object.keys(t.getListeners()).length>0&&t.clone().draw(this.offCtx),(null==t?void 0:t.nanoid)&&!Reflect.get(this.shapesActionsProxy,t.nanoid)||t.draw(this.ctx)}))}clear(){this.renderChildren=[],this.shapesSet.clear(),this.setProxy(),this.ctx.clearRect(0,0,this.width,this.height),this.offCtx.clearRect(0,0,this.width,this.height),this.render()}hitJudge(t,e){const s=M(Array.from(this.offCtx.getImageData(t*this.dpr,e*this.dpr,1,1).data));return this.shapesSet.has(s)?s:void 0}touchStartHandler(t){const e=t.touches[0],{x:s,y:r}=e,i=this.hitJudge(s,r);this.eventSimulator.addAction({type:E.Down,id:i},t)}touchEndHandler(t){const e=t.changedTouches[0],{x:s,y:r}=e,i=this.hitJudge(s,r);this.eventSimulator.addAction({type:E.Up,id:i},t)}clickHandle(t,{x:e,y:s}){const r=this.hitJudge(e,s);this.eventSimulator.addAction({type:E.Down,id:r},t),this.eventSimulator.addAction({type:E.Up,id:r},t)}setActions(t){this.shapesActionsList=[...t],this.setProxy(),this.render()}setProxy(){const t={};this.shapesActionsList.forEach((e=>{Reflect.set(t,e,!0)})),this.shapesActionsProxy=new Proxy(t,{set:this.proxySetFn.bind(this)})}proxySetFn(t,e,s){return Reflect.set(t,e,s),this.onChange&&this.onChange(e),!0}},t.createId=C,t.createOnceId=b,t.guideRenderFunc=k,t.idToRgba=x,t.rgbaToId=M,Object.defineProperty(t,"__esModule",{value:!0})}));
